# 要件定義書

## 1. プロダクト概要
本プロダクトは、Markdown形式で記述された資料をWeb上でスライドとして編集・プレビュー・PDF出力できるSaaS型アプリケーションである。ユーザーはダッシュボード上で自身のスライドを管理し、認証機能により個人ごとのデータ管理を実現する。

## 2. 機能要件

### 2.1. Markdown入力機能
- Markdownエディタを用いたスライド原稿の作成・編集
- 入力内容の即時保存・バリデーション

### 2.2. スライドプレビュー機能
- Markdown入力内容をスライド形式で即時プレビュー
- スライドショー表示
- スライドの一覧サムネイル表示

### 2.3. PDF出力機能
- 編集中のスライドをPDF形式でダウンロード可能
- PDF出力時のレイアウト最適化

### 2.4. シート(ダイアログ)・管理機能
- 作成済みスライドの一覧表示・新規作成・削除
- スライドごとの編集・プレビュー・出力操作

### 2.5. 認証・ユーザー管理・ユーザー種別
- 外部認証（OAuth等）によるユーザー認証
- ユーザーごとのデータ分離・管理

#### 全ユーザー共通
- Markdown編集・スライドショー・スライド一覧・PDF出力が可能
- 外部画像はホワイトリストURLのみ許可

#### 非ログインユーザー
- スライドの保存は不可
- 全画面プレビューURL発行は不可
- 画像アップロードは一時的なblob表示のみ（保存不可）

#### ログインユーザー
- スライドの保存・全画面プレビューURL発行が可能
- 画像アップロード・保存が可能（Cloudflare Imagesに永続保存、mdに画像URLを埋め込む）
- 保存数や画像数に上限あり（例：10件まで、詳細は別途定義）

#### 課金ユーザー(予定)
- ログインユーザーの全機能に加え、保存可能なスライド数・画像数・容量が拡張される
- 追加のプレミアム機能（将来拡張）も利用可能

## 3. 非機能要件

### 3.1. パフォーマンス要件
- エディタ・プレビュー・PDF出力の操作応答時間は2秒以内

### 3.2. セキュリティ要件
- XSS/CSRF等のWeb脅威対策
- API・ストレージへのアクセス制御

### 3.3. 保守性・拡張性
- 関心の分離を徹底したレイヤードアーキテクチャ
- 型安全・テスト容易性を考慮した実装
- 機能追加時の影響範囲最小化

## 4. 画面仕様

### 4.1. 主要画面一覧
- ダッシュボード画面(下記を含む)
  - Markdownエディタ部分
  - スライドショー部分
  - スライド一覧部分
  - シート(ダイアログ)部分
- プロファイル画面
- スライド全画面表示(プレビューURL発行)

## 5. 技術要件

### 5.1. フロントエンド技術
- Next.js（App Router構成）
- TypeScript
- tailwind css

### 5.2. ライブラリ・フレームワーク
- 認証：NextAuth.js
- Markdown処理：独自実装＋外部パーサ
- UI：shadcn/uiとそれを利用した独自コンポーネント

### 5.3. 型安全・テスト
- 型定義：TypeScript, Zod等(予定)
- テスト：Jest, React Testing Library(予定)

## 6. データ構造・契約

### 6.1. 入出力データの型定義
- スライドデータ：タイトル、Markdown本文、作成日時、更新日時、ユーザーID
- ユーザーデータ：ID、表示名、認証情報
- 型定義はTypeScriptによる定義

### 6.2. ストレージ設計（Turso + Drizzle ORM + NextAuth.js + Cloudflare Images）
- ストレージにはTursoを利用し、全てのスライド・ユーザーデータを永続化する。
- ORMには型安全かつマイグレーション管理が容易なDrizzle ORMを採用し、Tursoとの連携・スキーマ管理・DB操作を行う。
- 認証にはNextAuth.jsを用い、外部認証プロバイダと連携してユーザー認証を実現する。
- NextAuth.jsで認証されたユーザー情報（user_id等）をDrizzle ORM経由でTursoに保存・参照し、ユーザーごとのデータ分離・認可制御を徹底する。
- アプリケーションはAPI経由、もしくはServerAction経由でアクセスし、スライド・ユーザー情報のCRUD操作を行う。
- Tursoのバックアップ・マイグレーション機能およびDrizzleのマイグレーション管理を活用し、運用・拡張性を担保する。

#### 画像保存設計（Cloudflare Images）
- 画像保存にはCloudflare Imagesを利用し、ユーザーがアップロードした画像を最適化・CDN配信する。
- Next.js API経由でCloudflare Imagesに画像をアップロードし、発行された画像URLをmd本文に埋め込む。
- 非ログインユーザーは画像アップロード時にblob一時URLでのみ表示可能（保存不可）。
- ログインユーザーは画像アップロード・保存が可能（Cloudflare Imagesに永続保存）。
- 課金ユーザーは保存容量・画像数上限を拡張可能。
- 外部画像はホワイトリストURLのみ許可。
- Cloudflare Images無料枠：1,000画像保存、月10万リクエスト（超過時は従量課金）。

##### 画像保存フロー（概要）
1. ユーザーが画像をアップロード
2. Next.js API経由でCloudflare Imagesに保存
3. 画像URLを取得し、md本文に埋め込む
4. 非ログイン時はblob一時URLでのみ表示（保存不可）

## 7. 将来拡張・ロードマップ
- チーム・組織単位でのスライド共有機能
- テンプレート・テーマ切替機能
- 外部ストレージ連携（Google Drive等）
- スライド公開・共有URL発行
- 多言語対応

## 8. 制約事項・留意点
- ドメインロジックと副作用処理の分離を厳守
- 依存性は明示的に管理し、グローバル状態の利用を避ける
- データ構造・型定義の契約を遵守
- 公開インターフェースは最小限とし、内部実装はカプセル化
- 命名は目的を明示し、ドメイン用語を優先

---

## 要約
本要件定義ドラフトは、Markdownベースのスライド生成・管理SaaSの全体像を、機能・非機能・画面・技術・データ構造・拡張性・制約の観点から網羅的かつ簡潔に整理したものである。現状のディレクトリ・ファイル構成およびrequirements.mdの内容を反映し、今後の設計・実装・運用の指針となる。